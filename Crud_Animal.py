import time
import sys
import json
import os

ARQUIVO = 'animal.json'

def linha():
    print("-" * 60)

def add():
    while True:
        add1 = input("\n‚ùî Deseja algo mais?\n1Ô∏è‚É£  Sim\n2Ô∏è‚É£  N√£o\n")
        if add1 == "1":
            time.sleep(0.5)
            return
        elif add1 == "2":
            time.sleep(1)
            end()   
        else:
            invalid()

def invalid():
    print("ü§≠ Oops... N√£o localizei a op√ß√£o informada.")
    time.sleep(0.5)
    print("üîÉ Vamos tentar novamente?")
    time.sleep(0.5)

def end():
    time.sleep(1)
    print("üëã Saindo...")
    time.sleep(1)
    print("ü´Ç  Obrigado!")
    time.sleep(1)
    print("üê∂ Au au!")
    time.sleep(1)
    sys.exit()

def carregar_animais():
    if not os.path.exists(ARQUIVO):
        return []
    try:
        with open(ARQUIVO, 'r') as f:
            conteudo = f.read()
            if not conteudo:
                return []
            return json.loads(conteudo)
    except json.JSONDecodeError:
        print("‚ö†Ô∏è ERRO! O arquivo JSON est√° corrompido ou mal formatado.")
        return []

def salvar_animais(animais):
    with open(ARQUIVO, 'w') as f:
        json.dump(animais, f, indent=2)

def criar_animal(nome, especie, idade):
    animais = carregar_animais()
    novo_id = 1 if not animais else animais[-1]['id'] + 1
    novo_animal = {
        "id": novo_id,
        "nome": nome,
        "especie": especie,
        "idade": idade
    }
    animais.append(novo_animal)
    salvar_animais(animais)
    print(f"\n‚úÖ O cadastro de {nome} foi criado com sucesso!")
    add()

def listar_animais():
    tentativas = 0
    while tentativas < 3:
        time.sleep(0.5)
        senha = input("üîë Informe a senha do administrador: ").lower()
        if senha == "cachorrinho":
            animais = carregar_animais()
            time.sleep(0.5)
            print("üß† Buscando dados")
            time.sleep(0.5)
            if not animais:
                print("‚ùï Nenhum animal cadastrado.")
                add()
            else:
                print("üëá Estes s√£o os animais cadastrados at√© o momento:")
                for animal in animais:
                    time.sleep(0.5)
                    linha()
                    print(f"ID: {animal['id']} | Nome: {animal['nome']} | Esp√©cie: {animal['especie']} | Idade: {animal['idade']}")
                    linha()
                add()
            return
        else:
            tentativas += 1
            time.sleep(0.5)
            print(f"‚ùå Senha incorreta. Tentativa {tentativas}/3.\n")
    print("üö´ N√∫mero m√°ximo de tentativas excedido. Voc√™ ser√° desconectado do sistema.\n")
    end()


def buscar_animal():
    nome_input = input("üìõ Informe o nome do animal que deseja localizar: ").upper()
    animais = carregar_animais()
    encontrados = [a for a in animais if a['nome'] == nome_input]
    while True:
        if not encontrados:
            try:
                again = int(input("‚ùå Animal n√£o encontrado. Deseja tentar novamente?\n1Ô∏è‚É£  Sim\n2Ô∏è‚É£  N√£o\n"))
                match again:
                    case 1:
                        buscar_animal()
                        break
                    case 2:
                        add()
                        break
                    case _:
                        invalid()
            except ValueError:
                invalid()
                continue
                
        if len(encontrados) == 1:
            animal = encontrados[0]
            time.sleep(0.5)
            linha()
            print(f"ID: {animal['id']} | Nome: {animal['nome']} | Esp√©cie: {animal['especie']} | Idade: {animal['idade']}")
            add()
        else:
            print(f"‚ö†Ô∏è  Foram encontrados {len(encontrados)} animais com o nome '{nome_input}':")
            for a in encontrados:
                time.sleep(0.5)
                linha()
                print(f"üîπ ID: {a['id']} | Esp√©cie: {a['especie']} | Idade: {a['idade']}")
            add()
        break

def deletar_animal():
    try:
        id_delete = int(input("üîç Informe o ID do animal que deseja excluir: "))
    except ValueError:
        invalid()

    animais = carregar_animais()
    animal = next((a for a in animais if a['id'] == int(id_delete)), None)

    if not animal:
        print("üß† Buscando dados")
        time.sleep(0.5)
        print("‚ùå Animal n√£o encontrado na base de dados.")
        time.sleep(0.5)
        try:
            again = int(input("\nüîÉ Quer tentar novamente?\n1Ô∏è‚É£  Sim\n2Ô∏è‚É£  N√£o\n"))
            match again:
                case 1:
                    deletar_animal()
                case 2:
                    add()
        except ValueError:
            invalid()
    else:
            print("üß† Buscando dados")
            time.sleep(0.5)
            print("üêæ Animal localizado")
            time.sleep(0.5)
            linha()
            print(f"ID: {animal['id']} | Nome: {animal['nome']} | Esp√©cie: {animal['especie']} | Idade: {animal['idade']}")
            linha()
            try:
                confirm = int(input("ü§î Deseja prosseguir com a exclus√£o dos dados acima?\n1Ô∏è‚É£  Sim\n2Ô∏è‚É£  N√£o: "))
                match confirm:
                    case 1:
                        animais = [a for a in animais if a['id'] != id_delete]
                        time.sleep(0.5)
                        print("\nüóëÔ∏è Deletando...")
                        time.sleep(0.5)
                        salvar_animais(animais)
                        print(f"\n‚úÖ Cadastro n¬∫ {id_delete} exclu√≠do com sucesso.\n")
                        time.sleep(0.5)
                        add()
                    case 2:
                        print("‚ùå Exclus√£o cancelada.")
                        add()
            except ValueError:
                invalid()

def atualizar_animal():
    try:
        id_atualizar = int(input("\nüîç Informe a ID do animal que deseja atualizar: "))
    except ValueError:
        time.sleep(0.5)
        invalid()
    animais = carregar_animais()
    encontrados = [a for a in animais if a['id'] == id_atualizar]
    if not encontrados:
        print("‚ùå Animal n√£o encontrado.")
        try:
            again = int(input("\nüîÉ Quer tentar novamente?\n1Ô∏è‚É£  Sim\n2Ô∏è‚É£  N√£o\n"))
            match again:
                case 1:
                    atualizar_animal()
                case 2:
                    add()
        except ValueError
            invalid()

    if len(encontrados) > 1:
        print("‚ö†Ô∏è  Existe mais de um animal com esse nome:")
    else:
        animal = encontrados[0]
        for a in encontrados:
            print("üß† Buscando dados")
            time.sleep(0.5)
            print("üêæ Animal localizado")
            time.sleep(0.5)
            linha()
            print(f"üîπ ID: {a['id']} | Nome: {a['nome']} | Esp√©cie: {a['especie']} | Idade: {a['idade']}")
            linha()
    try:
        confirm = int(input("‚ùì Deseja atualizar o cadastro acima?\n1Ô∏è‚É£  Sim\n2Ô∏è‚É£  N√£o "))
        match confirm:
            case 1:
                nome_atual = input("\n‚úèÔ∏è  Informe o nome: ").upper()
                especie_atual = input("‚úèÔ∏è  Informe a esp√©cie: ").upper()
                idade_atual = input("‚úèÔ∏è  Informe a idade: ")
            case 2:
                print("‚ùå Atualiza√ß√£o cancelada.")
                add()
    except ValueError:
        invalid()
    try:
            confirm = int(input("\nü§î Confirma a atualiza√ß√£o?\n1Ô∏è‚É£  Sim\n2Ô∏è‚É£  N√£o\n"))
            match confirm:
                case 1:
                    if not nome_atual or not especie_atual or not idade_atual:
                        print("‚ùå Todos os campos devem ser preenchidos.")
                        return
                    animal['nome'] = nome_atual
                    animal['especie'] = especie_atual
                    animal['idade'] = idade_atual
                    salvar_animais(animais)
                    linha()
                    print("‚úÖ Cadastro atualizado com sucesso!")
                    linha()
                    add()
                case 2:
                    print("‚ùå Atualiza√ß√£o cancelada.")
                    add()
    except ValueError:
        invalid()

def ask_geral(sim_nao):
    while True:
        resp1 = input(sim_nao).strip().lower()
        if resp1 == "sim":
            input("‚ùì Qual? ")
            break
        elif resp1 in ("n√£o", "nao"):
            break
        else:
            invalid()

def ask_foto(foto):
    while True:
        resp2 = input(foto).strip().lower()
        if resp2 == "sim":
            print("ü§≥ Insira a foto:")
            time.sleep(1)
            linha()
            print("‚¨ÜÔ∏è  Uploading...")
            linha()
            time.sleep(1)
            break
        elif resp2 in ("n√£o", "nao"):
            time.sleep(1)
            break
        else:
            invalid()

def info():
    while True:
        info_add = input("\n‚ùì Deseja adicionar alguma informa√ß√£o complementar?\n1Ô∏è‚É£  Sim\n2Ô∏è‚É£  N√£o\n")
        if info_add == "1":
            input("\n‚ÑπÔ∏è  Insira a informa√ß√£o: ")
            time.sleep(1)
            print("‚úåÔ∏è  Obrigado pelas informa√ß√µes. Nossa equipe ir√° at√© o local em instantes.")
            add()
            return
        elif info_add == "2":
            time.sleep(1)
            print("‚úåÔ∏è  Obrigado pelas informa√ß√µes. Nossa equipe ir√° at√© o local em instantes.")
            add()
            return
        else:
            invalid()

def menu_crud1():
    while True:
        print("\n1Ô∏è‚É£  Cadastrar animal") #OK
        print("2Ô∏è‚É£  Localizar animal") #OK
        print("3Ô∏è‚É£  Atualizar o cadastro de um animal") #OK
        print("4Ô∏è‚É£  Excluir um animal") #OK
        print("5Ô∏è‚É£  Listar animais cadastrados") #OK
        print("6Ô∏è‚É£  Solicitar um resgate") # OK
        print("7Ô∏è‚É£  Sair")

        try:
            opcao = int(input("‚òùÔ∏è  Escolha uma das op√ß√µes acima: "))
        except ValueError:
            invalid()
            continue

        match opcao:
            case 1:
                time.sleep(0.5)
                nome = input("\nüìõ Qual o nome do bichinho? ").upper()
                especie = input("ü§î Qual a esp√©cie do bichinho? (ex.: gato, cachorro, hamster...) ").upper()
                idade = input("üî¢ Qual a idade estimada do bichinho? ")
                ask_geral("üò∑ Ele possui algum tipo de enfermidade? ")
                ask_geral("‚ûï Deseja inserir mais alguma informa√ß√£o adicional? ")
                ask_foto("üì∏ Deseja inserir alguma foto do animal? ")
                criar_animal(nome, especie, idade)
            case 2:
                buscar_animal()
            case 3:
                atualizar_animal()
            case 4:
                deletar_animal()
            case 5:
                listar_animais()
            case 6:
                time.sleep(0.5)
                print("\nüö® Vamos iniciar a solicita√ß√£o de resgate.")
                time.sleep(0.5)
                input("\nüìå Informe o endere√ßo da ocorr√™ncia: ")
                while True:
                    tel = input("üìû Informe um telefone para contato com DDD: ").strip()
                    if tel.isdigit() and len(tel) in [10, 11]:
                        break
                    else:
                        invalid()
                info()
            case 7:
                end()
                break
            case _:
                invalid()

linha()
print("üêæ Ol√°! Bem-vindo ao Centro de Ado√ß√£o Lu√≠sa Mel! üêæ")
linha()
time.sleep(0.5)
print("üî¢ Informe o n√∫mero correspondente √† op√ß√£o que deseja: üëá")
menu_crud1()
